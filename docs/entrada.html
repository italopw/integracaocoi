<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento Operacional - Entrada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tipografia corporativa e cores */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #333; }
        .header-bg { background-color: #0d2545; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card { transition: box-shadow 0.2s; border-radius: 8px; }
        .card:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); }
        textarea { resize: vertical; min-height: 120px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06); }
        .section-name { color: #0d2545; }
        .priority-select { border-radius: 6px; border: 1px solid #ccc; padding: 6px; }

        /* Estilo para a mensagem de feedback */
        #feedback-message { transition: opacity 0.5s, transform 0.5s; }
        .fade-in { opacity: 1; transform: translateY(0); }
        .fade-out { opacity: 0; transform: translateY(10px); }
    </style>

    <!-- Firebase SDKs (opcionais) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis Globais (podem ser injetadas pelo ambiente de execu√ß√£o)
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db = null, auth = null, userId = null;

        const SECTORS = [
            'MOEGAS/RECEP√á√ÉO', 'SILOS E PR√â-SECAGENS', 'SILO PULM√ÉO',
            'SILOS DE REPASSE', 'BENEFICIAMENTO', 'ENSAQUE', 'MARCOLD',
            'GRANELEIRO ADRIANA'
        ];

        // Utilit√°rio para gerar IDs compat√≠veis com os IDs existentes no HTML
        function makeId(nome) {
            return nome
                .toLowerCase()
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .replace(/[^a-z0-9]+/gi, '-')
                .replace(/(^-|-$)/g, '');
        }

        // --- Inicializa√ß√£o Firebase (segura: s√≥ tenta se houver config) ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.log('Firebase config n√£o encontrada ‚Äî executando em modo offline/fallback.');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`‚úÖ Autentica√ß√£o Firebase bem-sucedida. User ID: ${userId}`);
                await loadLastStatusFromFirestore();
            } catch (err) {
                console.error('‚ùå Falha na inicializa√ß√£o/autentica√ß√£o Firebase:', err);
                // fallback: continuar sem Firebase (local only)
            }
        }

        // Refer√™ncias Firestore (seguras: apenas se db estiver configurado)
        function getPlanningDocRefPrivate() {
            if (!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/planning_data/current_status`);
        }

        function getPlanningDocRefPublic() {
            if (!db) return null;
            return doc(db, `artifacts/${appId}/public/data/planning_data/current_status`);
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showFeedback(message, isError = false) {
            const msgEl = document.getElementById('feedback-message');
            if (!msgEl) return;
            msgEl.textContent = message;
            msgEl.className = `p-3 rounded-md mt-4 font-semibold text-center fade-in ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            msgEl.style.opacity = '1';
            setTimeout(() => {
                msgEl.className = 'fade-out';
                setTimeout(() => { msgEl.textContent = ''; msgEl.style.opacity = '0'; }, 500);
            }, 5000);
        }

        // --- Persist√™ncia ---
        async function loadLastStatusFromFirestore() {
            try {
                const ref = getPlanningDocRefPrivate();
                if (!ref) return;
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    (data.setores || []).forEach(setor => {
                        const statusEl = document.getElementById(`status-${setor.id}`);
                        const priorityEl = document.getElementById(`priority-${setor.id}`);
                        if (statusEl) statusEl.value = setor.status || '';
                        if (priorityEl) priorityEl.value = setor.prioridade || 'NORMAL';
                    });
                    showFeedback('√öltimo status de trabalho carregado com sucesso.', false);
                } else {
                    console.log('Nenhum status anterior encontrado no Firestore (private).');
                }
            } catch (err) {
                console.error('Erro ao carregar status do Firestore (private):', err);
            }
        }

        async function saveStatusPrivate(formData = null) {
            try {
                const ref = getPlanningDocRefPrivate();
                if (!ref) return;
                const dataToSave = formData || collectFormData(false);
                await setDoc(ref, dataToSave);
                console.log('Rascunho salvo no Firestore (private).');
            } catch (err) {
                console.error('Erro ao salvar rascunho no Firestore (private):', err);
            }
        }

        // --- Form helpers ---
        function collectFormData(requireFull) {
            const dataRefEl = document.getElementById('data-ref');
            const turnoRefEl = document.getElementById('turno-ref');
            const dataRef = dataRefEl ? dataRefEl.value : '';
            const turnoRef = turnoRefEl ? turnoRefEl.value : '';

            if (requireFull && (!dataRef || !turnoRef)) return null;

            const setoresData = SECTORS.map(nome => {
                const id = makeId(nome);
                const statusEl = document.getElementById(`status-${id}`);
                const priorityEl = document.getElementById(`priority-${id}`);
                const status = statusEl ? statusEl.value.trim() : '';
                const prioridade = priorityEl ? priorityEl.value.toUpperCase() : 'NORMAL';
                if (requireFull && !status) return null;
                return { id, nome, status, prioridade };
            }).filter(item => item !== null);

            if (requireFull && setoresData.length === 0) return null;

            return { timestamp: Date.now(), data: dataRef, turno: turnoRef, setores: setoresData };
        }

        // --- Transmiss√£o ---
        // Envia dados para a Interface B (integra√ß√£o).
        // Se existir a vari√°vel global `_integration_endpoint`, faz POST JSON para l√°.
        // Caso contr√°rio, salva em localStorage como fallback e abre `integracao.html`.
        async function transmitToInterfaceB(formData) {
            const endpoint = typeof _integration_endpoint !== 'undefined' ? _integration_endpoint : null;
            if (endpoint) {
                try {
                    const resp = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    let json = null;
                    try { json = await resp.json(); } catch (e) { /* ignore non-json */ }
                    showFeedback('Dados enviados para Interface B com sucesso.', false);
                    return { success: true, result: json };
                } catch (err) {
                    console.error('Erro ao enviar para Interface B:', err);
                    showFeedback('Erro ao enviar para Interface B: ' + (err.message || err), true);
                    return { success: false, error: err };
                }
            }

            // Fallback: salvar em localStorage e abrir a p√°gina de integra√ß√£o
            try {
                localStorage.setItem('pending_planning', JSON.stringify(formData));
                // Abre a Interface B em nova aba; a p√°gina B deve ler localStorage['pending_planning'] ao carregar
                window.open('integracao.html', '_blank');
                showFeedback('Dados preparados e abertos na Interface B (abrindo integracao.html).', false);
                return { success: true, result: 'localStorage' };
            } catch (err) {
                console.error('Erro no fallback de transmiss√£o:', err);
                showFeedback('Erro ao preparar dados para Interface B: ' + (err.message || err), true);
                return { success: false, error: err };
            }
        }

        async function handleTransmission(event) {
            event?.preventDefault?.();
            const formData = collectFormData(true);
            if (!formData) {
                showFeedback('‚ö† Por favor, preencha a Data, o Turno e pelo menos um Status de Setor.', true);
                return;
            }

            // 1) Salva rascunho privado (n√£o bloqueante para envio)
            try {
                await saveStatusPrivate(formData);
            } catch (err) {
                console.warn('Aviso: falha ao salvar rascunho privado (continua tentativa de envio):', err);
            }

            // 2) Tenta salvar na √°rea p√∫blica (Firestore) se poss√≠vel
            let publicSaved = false;
            try {
                const pubRef = getPlanningDocRefPublic();
                if (pubRef) {
                    await setDoc(pubRef, formData);
                    publicSaved = true;
                    showFeedback('üöÄ Planejamento salvo e Dashboard COI atualizado com sucesso!', false);
                }
            } catch (err) {
                console.error('Erro ao salvar p√∫blico (Firestore):', err);
                // n√£o interrompe o envio para Interface B
            }

            // 3) Envia para a Interface B (endpoint configur√°vel ou fallback local)
            const result = await transmitToInterfaceB(formData);
            if (result.success && publicSaved) {
                // ambos OK ‚Äî nada extra a fazer
                return true;
            }

            // Se nenhum dos envios foi bem-sucedido, j√° mostramos mensagens de erro em transmitToInterfaceB
            return result.success;
        }

        function clearForm() {
            SECTORS.forEach(nome => {
                const id = makeId(nome);
                const statusEl = document.getElementById(`status-${id}`);
                const priorityEl = document.getElementById(`priority-${id}`);
                if (statusEl) statusEl.value = '';
                if (priorityEl) priorityEl.value = 'NORMAL';
            });
            const dataRef = document.getElementById('data-ref');
            const turnoRef = document.getElementById('turno-ref');
            if (dataRef) dataRef.value = getCurrentDateString();
                if (turnoRef) turnoRef.value = 'A';
            showFeedback('Formul√°rio limpo e pronto para um novo preenchimento.', false);
            saveStatusPrivate();
        }

        // Setup inicial
        document.addEventListener('DOMContentLoaded', () => {
            const dataRef = document.getElementById('data-ref');
            if (dataRef) dataRef.value = getCurrentDateString();
            const turnoRef = document.getElementById('turno-ref');
            if (turnoRef) turnoRef.value = 'A';

            const form = document.getElementById('transmission-form');
            form?.addEventListener('submit', handleTransmission);

            document.getElementById('clear-form-btn')?.addEventListener('click', (e) => { e.preventDefault(); clearForm(); });

            SECTORS.forEach(nome => {
                const id = makeId(nome);
                document.getElementById(`status-${id}`)?.addEventListener('input', () => saveStatusPrivate());
                document.getElementById(`priority-${id}`)?.addEventListener('change', () => saveStatusPrivate());
            });

            document.getElementById('data-ref')?.addEventListener('change', () => saveStatusPrivate());
            document.getElementById('turno-ref')?.addEventListener('change', () => saveStatusPrivate());

            // Inicializa Firebase (se houver configura√ß√£o dispon√≠vel)
            initializeFirebase();
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <form id="transmission-form">
        <!-- Cabe√ßalho Corporativo e Contexto -->
        <header class="header-bg p-4 sticky top-0 z-10">
            <h1 class="text-3xl font-extrabold flex items-center justify-center">
                <span class="mr-3">üìã</span> Planejamento Operacional
            </h1>
            <!-- Seletores de Contexto -->
            <div class="flex flex-wrap justify-center gap-6 mt-4 p-3 bg-white/10 rounded-lg">
                <div class="flex items-center space-x-2">
                    <label for="data-ref" class="font-semibold">Data:</label>
                    <input type="date" id="data-ref" required class="p-2 rounded-md text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="turno-ref" class="font-semibold">Turno:</label>
                    <select id="turno-ref" required class="p-2 rounded-md text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="A">Turno: A</option>
                        <option value="B">Turno: B</option>
                        <option value="C">Turno: C</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Principal - Setores -->
        <main class="max-w-6xl mx-auto p-6">
            <div id="feedback-message" class="fade-out" style="opacity: 0;"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Cada bloco abaixo usa IDs compat√≠veis com a fun√ß√£o makeId() -->
                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">MOEGAS/RECEP√á√ÉO</h2>
                    <textarea id="status-moegas-recepcao" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-moegas-recepcao" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-moegas-recepcao" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">SILOS E PR√â-SECAGENS</h2>
                    <textarea id="status-silos-e-pre-secagens" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-silos-e-pre-secagens" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-silos-e-pre-secagens" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">SILO PULM√ÉO</h2>
                    <textarea id="status-silo-pulmao" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-silo-pulmao" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-silo-pulmao" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">SILOS DE REPASSE</h2>
                    <textarea id="status-silos-de-repasse" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-silos-de-repasse" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-silos-de-repasse" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">BENEFICIAMENTO</h2>
                    <textarea id="status-beneficiamento" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-beneficiamento" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-beneficiamento" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">ENSAQUE</h2>
                    <textarea id="status-ensaque" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-ensaque" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-ensaque" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">MARCOLD</h2>
                    <textarea id="status-marcold" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-marcold" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-marcold" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>

                <div class="card bg-white p-6 shadow-lg">
                    <h2 class="section-name text-2xl font-bold mb-4">GRANELEIRO ADRIANA</h2>
                    <textarea id="status-graneleiro-adriana" placeholder="Descreva o status e os pr√≥ximos passos para o setor." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <label for="priority-graneleiro-adriana" class="block mt-3 text-sm font-medium text-gray-700">Prioridade de A√ß√£o:</label>
                    <select id="priority-graneleiro-adriana" class="priority-select w-full mt-1">
                        <option value="NORMAL">Normal</option>
                        <option value="BAIXA">Baixa</option>
                        <option value="M√âDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="mt-8 flex justify-center space-x-4">
                <button type="button" id="clear-form-btn" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-100 transition duration-150 shadow-sm font-semibold">Limpar Formul√°rio</button>
                <button type="submit" class="px-8 py-3 rounded-lg text-white bg-green-600 hover:bg-green-700 transition duration-150 shadow-lg font-bold">Salvar e Atualizar Planejamento</button>
            </div>
        </main>
    </form>
</body>
</html>